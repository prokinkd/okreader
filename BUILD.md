Building components
-------------------

Note: The build system is intended to run on Debian or Ubuntu. Cross-compilation is implemented for packages building and `qemu-debootstrap` is used for rootfs creation.

1) Install prerequisites:

    sudo apt-get update
    sudo apt-get install git build-essential libtool autoconf cmake luarocks zlib1g-dev libffi-dev gettext wget hashalot u-boot-tools debootstrap curl coreutils xz-utils gcc-arm-none-eabi qemu-user-static debian-archive-keyring

2) Clone this repo:

    git clone git@github.com:prokinkd/okreader.git

or

    git clone https://github.com/prokinkd/okreader.git

3) Fetch all resources.

Warning: If you are not authenticated to GitHub with your git setup, you will need to replace `git@github.com:` occurences with `https://github.com/` in `.gitmodules` file before working with submodules.

    cd okreader
    git submodule init
    git submodule update
    ./fetch.sh all

4) Build all packages:

    ./build.sh all
    
Note, koreader dependecies require autoconf >= 2.65. You might have to manually specify an autoconf version, for example:

    AUTOCONF=autoconf2.65 ./build.sh all

Build artifacts:

    src/u-boot/u-boot.bin                       # U-Boot (bootloader) image (imx5-based devices)
    src/linux/arch/arm/boot/uImage              # Linux kernel image (imx5-based devices)
    src/linux-imx6/arch/arm/boot/uImage         # Linux kernel image (imx6-based devices)
    src/linux-okreader-modules-imx5_*_armhf.deb # Linux kernel modules (imx5-based devices)
    src/linux-okreader-modules-imx6_*_armhf.deb # Linux kernel modules (imx6-based devices)
    src/firmware-okreader*_armhf.deb            # WiFi firmware (all devices)
    src/koreader_*_armhf.deb                    # koreader (all devices)
    src/kobo_hwconfig/kobo-hwconfig_*_armhf.deb # GPL implementation of kobo_hwconfig (all devices)

5) Prepare a Debian rootfs (including the .deb packages previously built):

    sudo ./build_rootfs.sh

Rootfs artifacts:

    rootfs                           # rootfs directory
    rootfs-fresh-backup.tar.xz       # debootstrapped system without further modifications, used as
                                       bandwidth saving measure for repeated script runs
    okreader-rootfs-release-*.tar.xz # rootfs release tarball (not generated by default)
